# Spring - DB Study project

## Project Spec
- 프로젝트 선택
    - Project: Gradle Project
    - Spring Boot: 2.7.3
    - Language: Java
    - Packaging: Jar
    - Java: 11
- Project Metadata
    - Group: com.example
    - Artifact: item-service
    - Name: spring-db-itemservice
    - Package name: com.example.itemservice
- Dependencies: **Spring Web**, **Thymeleaf**, **Lombok**
- DB : H2 database

## Package Design
- start
```
└── src
    ├── main
    │   ├── java
    │   │   └── com.example.itemservice
    │   │               ├── config
    │   │               │     └── MemoryConfig(C) 
    │   │               ├── domain
    │   │               │     ├── Item(C)           
    │   │               │     └── ItemSearchCondition(C) 
    │   │               ├── exception
    │   │               │     └── NotFoundException(C) 
    │   │               ├── repository
    │   │               │     ├── ItemRepository(I) 
    │   │               │     └── MemoryItemRepository(C)
    │   │               ├── service
    │   │               │     ├── ItemService(I)           
    │   │               │     └── ItemServiceImplV1(C) 
    │   │               ├──  web
    │   │               │      ├── controller
    │   │               │      │     ├── HomeController(C)
    │   │               │      │     └── ItemController(C)
    │   │               │      └──  dto
    │   │               │            ├──  request
    │   │               │            │      ├── RequestItemInsertDto(C)
    │   │               │            │      ├── RequestItemUpdateDto(C)
    │   │               │            │      └── RequestItemSelectDto(C)
    │   │               │            └──  response
    │   │               │                   └── ResponseItemSelectDto(C)
    │   │               ├── TestDataInit(C)
    │   │               └── ItemServiceApplication(C)
    │   └── resource
    │       ├── static
    │       │     ├──  css 
    │       │     │      └── bootstrap.min.css
    │       │     └── index.html
    │       ├── template
    │       │     ├──  css 
    │       │     │      └── bootstrap.min.css
    │       │     ├── item.html    
    │       │     ├── items.html   
    │       │     ├── addForm.html 
    │       │     └── editForm.html
    │       └── application.properties
    ├── test
    │   ├── java
    │   │   └── com.example.itemservice
    │   │                       └── repository
    │   │                                └── ItemRepositoryTest(C)
```

```
[DB Table]
drop table if exists item CASCADE;
create table item (
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);
```

## Study 내용
1. JdbcTemplate : JdbcTemplate을 사용해서 메모리에 저장하던 데이터를 데이터베이스에 저장
- **주요 기능 :** JdbcTemplate이 제공하는 주요 기능은 다음과 같다.
  - JdbcTemplate : 순서 기반 파라미터 바인딩을 지원한다.
  - NamedParameterJdbcTemplate : 이름 기반 파라미터 바인딩을 지원한다. (권장)
  - SimpleJdbcInsert : INSERT SQL을 편리하게 사용할 수 있다.
  - SimpleJdbcCall : 스토어드 프로시저를 편리하게 호출할 수 있다.
2. 데이터 접근 기술 - 테스트방법
- DB 분리
  - test전용 h2 db 생성 
  - application.properties(/test)에 적용
- 데이터 롤백
  - @BeforeEach, @AfterEach 적용
  - @Transactional
- 임베디드 모드 DB(h2)
  - src/test/resources/schema.sql
3. Mybatis
- JdbcTemplate보다 더 많은 기능을 제공하는 SQL Mapper
- SQL을 XML에 편리하게 작성할 수 있고 또 동적 쿼리를 매우 편리하게 작성
- MyBatis 설정
  - application.properties
- MyBatis 적용
  - @Repository MyBatisItemRepository
  - @Mapper ItemMapper(call at MyBatisItemRepository)
- MyBatis 기능 
  - 동적 쿼리
  - 기타 기능(애너테이션 sql, 문자열 대체(${}), 재사용 가능한 SQL 조각(sql>), Result Maps)
4. JPA(Java Persistence API)
- 자바 진영의 ORM(Object Relational Mapping) 기술 표준
- JPA는 애플리케이션과 JDBC 사이에서 동작
- JdbcTemplate이나 MyBatis 같은 SQL 매퍼 기술은 SQL을 개발자가 직접 작성해야 하지만, JPA를 사용하면 SQL도 JPA가 대신 작성하고 처리
- 실무에서는 JPA를 더욱 편리하게 사용하기 위해 스프링 데이터 JPA와 Querydsl이라는 기술을 함께 사용
- JPA 설정 : implementation 'org.springframework.boot:spring-boot-starter-data-jpa'(build.gradle)
- JPA 적용
  - Domain 객체 : orm mapping
  - Repository
    - 저장
    - 수정
    - 단건조회
    - 목록조회(jpql)
    - 삭제
5. Spring Data JPA
- Spring Data : 데이터를 어딘가(??)에 저장하고 조회하고(CRUD)….에 대해 추상화(공통화)하여 → 인터페이스 제공
  - Spring Data JPA, Spring Data mongo, Spring Data redis….
- Spring Data JPA 적용
  - SpringDataJpaItemRepository 구현
    - ItemService는 ItemRepository에 의존하기 때문에 ItemService에서 SpringDataJpaItemRepository를 그대로 사용할 수 없다.
    - JpaItemRepositoryV2를 구현하여 ItemrRepository와 SpringDataJpaItemRepository사이를 맞추기 위한 어댑터 처럼 사용된다.
      - save()  :  JpaRepository
      - update()
      - findById() : JpaRepository
      - findAll() : SpringDataJpaItemRepository
        - List<Item> findByItemNameLike(String itemName);
        - List<Item> findByPriceLessThanEqual(Integer price);
        - List<Item> findByItemNameLikeAndPriceLessThanEqual(String itemName, Integer price); : 쿼리메서드
        - @Query("select i from Item i where i.itemName like :itemName and i.price <= :price")
          List<Item> findItems(@Param("itemName") String itemName, @Param("price") Integer price); : 쿼리 직접 실행
6. Querydsl
- Querydsl 설정
- Querydsl 적용
- Spring Data Jpa, Querydsl용 Repository 분리
  - TestCode 정의